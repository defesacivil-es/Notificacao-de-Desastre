<!-- FORMUL√ÅRIO DE NOTIFICA√á√ÉO DE DESASTRES - (ORIGINAL) -->
<!-- https://defesacivil-es.github.io/Notifica√ß√£o de Desastres - (Original)/ -->

<!doctype html>
<html lang="pt-BR">
<head>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Notifica√ß√£o de Desastres - (cadastro)</title>

  <style>
    :root {
      --cor-principal: #2B7A78;
      --cor-secundaria: #DEF2F1;
      --cor-clara: #FEFFFF;
      --cor-escura: #17252A;
    }

    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background-color: var(--cor-secundaria);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      align-items: flex-start;
    }

    /* -- inserir no <style> j√° existente -- */
    .logo {
      width: 100%;            /* ocupa toda a largura poss√≠vel */
      /*max-width: 220px;       /* mas n√£o passa de 220px */
      height: auto;           /* mant√©m a propor√ß√£o */
      display: block;
      margin: 0 auto 12px;    /* centraliza e d√° espa√ßo abaixo */
    }
    .logo-wrap {
      text-align: center;
      margin-bottom: 8px;  /* espa√ßo entre imagem e t√≠tulo */
    }

    .container {
      background: var(--cor-clara);
      border-radius: 12px;
      padding: 25px 30px;
      margin: 30px;
      width: 100%;
      max-width: 950px;
      /* min-height: 1300px; /* ajuste conforme necess√°rio */
      height: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    h2 {
      text-align: center;
      color: var(--cor-escura);
      margin-bottom: 20px;
    }

    fieldset {
      border: 2px solid var(--cor-principal);
      border-radius: 8px;
      margin-bottom: 18px;
      padding: 15px 20px;
    }

    legend {
      font-weight: bold;
      color: var(--cor-principal);
      padding: 0 8px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-top: 10px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 4px;
      box-sizing: border-box;
    }

    /* Chrome, Edge, Opera, Safari */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }

    button {
      background-color: var(--cor-principal);
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      /*width: 100%;*/
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #205f5d;
    }

    #saveToSheetButton {
      background-color: #D2691E; /* laranja opaco */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #saveToSheetButton:hover {
      background-color: #B85C1A; /* tom ligeiramente mais escuro no hover */
    }

    #limpaToSheetButton {
      background-color: #DC143C; /* vermelho */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #limpaToSheetButton:hover {
      background-color: #B22222; /* tom ligeiramente mais escuro no hover */
    }

    .full {
      grid-column: 1 / -1; /* faz ocupar toda a linha */
    }

    .half {
      grid-column: span 1;  /* ocupa metade */
    }

    .span-2 {
      grid-column: span 2;
      width: 100%;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 16px 20px;
    }

    .grid-4 label {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
   
    .grid-4 :is(input, select) {
      height: 42px;
      box-sizing: border-box;
    }

    .grid-4 input,
    .grid-4 select,
    .grid-4 textarea {
      line-height: 42px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px 20px;
    }

    .grid-3 label {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
   
    .grid-3 :is(input, select) {
      height: 42px;
      box-sizing: border-box;
    }

    .grid-3 input,
    .grid-3 select,
    .grid-3 textarea {
      line-height: 42px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 20px;
    }

    .botoes-container {
      display: flex;
      justify-content: center; /* bot√µes no centro */
      align-items: center;
      gap: 150px;          /* espa√ßo entre os bot√µes */
      width: 100%; /* ocupa toda a largura dispon√≠vel */
      margin-top: 10px;
    }

    #tabelaDonativos {
      width: 100%;  
      max-width: 100%; 
      box-sizing: border-box;
      /* border-collapse: separate !important;  /* permite bordas arredondadas e for√ßa modo separado */
      border-spacing: 0;          /* remove espa√ßamento entre c√©lulas */
      /*border: 2px solid #2B7A78;  /* azul petr√≥leo */
      /*border-radius: 14px;        /* arredonda o contorno da tabela */
      overflow: hidden;           /* garante visual limpo */
    }

    #status {
     text-align: center;
     margin-top: 15px;
     font-weight: bold;
     font-size: 15px;
    }

    .quantidade-container {
     display: flex;
     align-items: center;
     gap: 8px;
    }

    .unidade-label {
     font-weight: bold;
     color: var(--cor-escura);
     white-space: nowrap;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      /*border: 1px solid #ccc;*/
      border: 1px solid #2B7A78;
      padding: 6px;
      text-align: center;
      font-size: 12px;
    }

    th {
      background-color: #87CEEB; /* azul c√©u */
      /*border: 2px solid #2B7A78; /* borda azul petr√≥leo */
      /*border-radius: 8px;        /* arredonda o contorno da tabela */
      color: white;              /* mant√©m o texto branco para contraste */
    }

    .btnExcluir {
      background-color: #c0392b;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .btnExcluir:hover {
      background-color: #922b21;
    }

    /* Reduz exatamente a altura do campo */
    .choices {
      width: 100% !important;       /* ocupa apenas a largura da coluna */
      max-width: 100% !important;   /* impede que estoure para fora */
      box-sizing: border-box !important;
      margin-top: 4px !important;
    }

    /* Ajusta a caixa interna para a mesma altura dos outros inputs */
    .choices__inner {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      border: 1px solid #ccc !important;
      border-radius: 6px !important;
      padding: 2px 7px !important;
      min-height: 44px !important;   /* <<< ajuste principal */
      height: auto !important;       /* <<< for√ßa a altura */
      display: flex;
      /* align-items: center;           /* centraliza o texto */
      align-items: flex-start !important;
      flex-wrap: wrap;
    }

    /* Ajusta o texto interno para n√£o aumentar a altura */
    .choices__inner .choices__item {
      padding: 0 !important;
      margin: 0 !important;
      font-size: 14px !important;
      line-height: 1.2 !important;   /* <<< evita expans√£o vertical */
    }

    /* Remove espa√ßo extra no modo single */
    .choices__list--single {
      padding: 0 !important;
    }

    /* Dropdown com altura normal */
    .choices__list--dropdown {
      border-radius: 6px !important;
      border: 1px solid #ccc !important;
      margin-top: 2px !important;
    }

    @media (min-width: 700px) {
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px 20px;
      }
    }

    @media print {
      /* Ocultar bot√µes */
      button, .sem-imprimir {
      display: none !important;
      }

      /* Ajustar largura da p√°gina */
      body {
        margin: 20px;
        font-size: 14px;
      }
    }

    @media print {
      .no-print {
      display: none !important;
      }

      /* Opcional ‚Äî esconder tamb√©m todos os bot√µes */
      /*button { */
      /*display: none !important;*/
      /*}*/
    }    

    /* === CONTAINER PRINCIPAL === */
    .choices, #itensSelect, #itensSelect + .choices {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      overflow: visible !important;
    }

    /* √Årea interna ajust√°vel */
    .choices__inner {
      display: flex !important;
      flex-wrap: wrap !important;
      padding: 8px !important;
      min-height: 44px !important;
      height: auto !important;
    }

    /* === GRID DAS TAGS (4 POR LINHA) === */
    .choices__list--multiple {
      display: grid !important;
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 8px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    /* Apar√™ncia das tags */
    .choices__list--multiple .choices__item {
      width: 100% !important;
      text-align: center !important;
      margin: 0 !important;
      padding: 4px 8px !important;
      font-size: 13px !important;
      border-radius: 6px !important;
      box-sizing: border-box !important;
    }

    /* === CENTRALIZA√á√ÉO DO PLACEHOLDER REAL === */
    .choices[data-type*="select-multiple"] 
    .choices__list--single 
    .choices__placeholder {
      width: 100% !important;
      text-align: center !important;
      display: block !important;
      margin: 0 auto !important;
    }

    /* Cor de fundo dos campos desabilitados */
    input:disabled,
    select:disabled,
    textarea:disabled {
      background-color: #e0e0e0; /* cinza mais escuro */
      color: #555;              /* texto mais apagado */
      cursor: not-allowed;      /* cursor de campo bloqueado */
    }
   
    #numeroOcorrencia {
      font-weight: bold;
      color: #000;
    }

    #numeroOcorrencia[readonly] {
      background-color: #d4f5d4;
      font-weight: bold;
      color: #000;
      cursor: not-allowed;
    }

  </style>

</head>

<body>

  <div class="container">
    <div class="logo-wrap">
      <img src="Logo_CEPDEC.PNG" alt="Logo da CEPDEC" class="logo">
    </div>

    <h2>Registro de Ocorr√™ncias e Desastres</h2>

    <form id="formOcorrencia">

      <fieldset>
        <legend>1. Identifica√ß√£o da Ocorr√™ncia</legend>
        <div class="grid-3">
          <label title= "Preenchimento autom√°tico - composi√ß√£o: ano m√™s dia - hora minuto - munic√≠pio - natureza - n√∫mero sequ√™ncial" class = "full">N√∫mero da Ocorr√™ncia <input type="text" name="numeroOcorrencia" id="numeroOcorrencia" readonly required></label>
          <label>Tipo de Ocorr√™ncia
            <select id="tipoOcorrenciaSelect" name="tipoOcorrencia" required>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Data da Ocorr√™ncia <input type="date" name="dataOcorrencia" required></label>
          <label>Hor√°rio da Ocorr√™ncia <input type="time" name="horarioOcorrencia" required></label>
        </div>
      </fieldset>
      
      <fieldset>
        <legend>2. Identifica√ß√£o do Comunicante</legend>
        <div class="grid-3">
          <label class="span-2">REPDEC - Respons√°vel
            <select id="repdecSelect" name="repdec" required>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Institui√ß√£o Comunicante
            <select id="instituicaoSelect" name="instituicaoComunicante" required>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Nome do Comunicante <input type="text" name="nomeComunicante" style="text-transform: uppercase;" required></label>
          <label>Telefone do Comunicante <input id="telefoneComunicante" name="telefoneComunicante" type="text" required maxlength="13" inputmode="numeric" placeholder="00 00000-0000"></label>
          <label>E-mail do Comunicante <input type="email" name="emailComunicante" required></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>3. Localiza√ß√£o da Ocorr√™ncia</legend>
        <div class="grid-3">
          <label>Munic√≠pio
            <select id="municipioOcorrenciaSelect" name="municipioOcorrencia" required>
              <option value="" disabled selected>Carregando...</option>     
            </select>      
          </label>
          <label>Bairro <input type="text" name="bairro" required></label>
          <label>Rua <input type="text" name="rua"></label>
          <label>N√∫mero <input type="number" name="numero"></label>
          <label>Complemento <input type="text" name="complemento"></label>
          <label>Ponto de Refer√™ncia <input type="text" name="pontoReferencia"></label>
          <label title= "Digite apenas os n√∫meros">Latitude - (Ex: -20,985815) <input id="latitude" type="text" name="latitude" maxlength="10" inputmode="numeric" placeholder="-00,000000"></label>
          <label title= "Digite apenas os n√∫meros">Longitude - (Ex: -40,985815) <input id="longitude" type="text" name="longitude" maxlength="10" inputmode="numeric" placeholder="-00,000000"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>4. Descri√ß√£o da Ocorr√™ncia</legend>
        <div class="grid-3">
          <label>Natureza do Desastre
            <select id="naturezaDesastreSelect" name="naturezaDesastre" required>
              <option value="">Selecione...</option>     
            </select>      
          </label>
          <label class = "span-2">COBRADE
            <select id="cobradeSelect" name="cobrade" required disabled>
              <option value="">Selecione a Natureza primeiro</option>     
            </select>      
          </label>
          <label class = "span-2">Rio ou C√≥rrego Pr√≥ximo <input type="text" name="rioCorregro"></label>
          <label  title="Informe a cota m√°xima de inunda√ß√£o atingida nas casas (em metros)!">Cota M√°xima de Inunda√ß√£o (mts) <input type="number" name="cotaMaxima" inputmode="decimal" step="0.01"></label>
          <label class = "full">Relato de Estrutura Colapsada <textarea name="relatoEstruturaColapsada"></textarea></label>
          <label class = "full">Relato Detalhado da Ocorr√™ncia <textarea name="relatoDetalhadoOcorrencia" required></textarea></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>5. Danos e Preju√≠zos Humanos</legend>
        <div class="grid-3">
          <label>Desalojados <input type="number" name="desalojados" min="0"></label>
          <label>Desabrigados <input type="number" name="desabrigados" min="0"></label>
          <label>Feridos <input type="number" name="feridos" min="0"></label>
          <label>Enfermos <input type="number" name="enfermos" min="0"></label>
          <label>Desaparecidos <input type="number" name="desaparecidos" min="0"></label>
          <label>√ìbitos <input type="number" name="obitos" min="0"></label>
          <label>Outras Pessoas Afetadas <input type="number" name="outrasAfetadas" min="0"></label>
          <label>Pessoas Encaminhadas para Abrigo <input type="number" name="pessoasAbrigo" min="0"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>6. Danos e Preju√≠zos Materiais</legend>
        <div class="grid-3">
          <label>Unidades Habitacionais Afetadas <input type="number" name="unidHabitAfetadas" min="0"></label>
          <label>Instala√ß√µes Particulares Afetadas <input type="number" name="instPartAfetadas" min="0"></label>
          <label>Instala√ß√µes P√∫blicas Afetadas <input type="number" name="instPublAfetadas" min="0"></label>
          <label>Vias interditadas <input type="number" name="viasInterditadas" min="0"></label>
          <label>Infraestruturas P√∫blicas Afetadas <input type="number" name="infraPublAfetadas" min="0"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>7. Participa√ß√£o Institucional e A√ß√µes Adotadas </legend>
        <div class="grid-3">
          <label class="full">Rela√ß√£o de Recursos Empenhados no Desastre
            <select id="recursosSelect" name="recursosEmpenhados" multiple>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label class="full">Participa√ß√£o Institucional
            <select id="participacaoSelect" name="participacaoInstitucional" multiple>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Total de Servidores Volunt√°rios Atuando pelo Munic√≠pio <input type="number" name="servidoresVoluntarios" min="0"></label>
          <label>Ativado SCO com a instala√ß√£o de um PC Local no Munic√≠pio?
            <select name="ativacaoSCO" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o munic√≠pio emitiu ou emitir√° decreto de situa√ß√£o de anormalidade!">O Munic√≠pio Emitiu ou Emitir√° Decreto de Situa√ß√£o de Anormalidade?
            <select name="emissaoDecreto" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o munic√≠pio necessita de apoio para o restabelecimento de servi√ßos essenciais!">O Munic√≠pio Necessita de Apoio?
            <select name="necessitaApoio" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o munic√≠pio solicitou ou solicitar√° Itens de Assist√™ncia Humanit√°ria da CEPDEC!">Solicita√ß√£o de IAH √† CEPDEC?
            <select name="solicitaIAH" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o foi Instalado Posto de Comando!">Houve Instala√ß√£o de Posto Comando?
            <select name="postoComando" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o foi Instalado Abrigo!">Houve Instala√ß√£o de Abrigo?
            <select name="instalacaoAbrigo" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o foi Instalado Centro de Log√≠stica Humanit√°ria!">Houve Instala√ß√£o de Centro Log√≠stica?
            <select name="centroLogistica" required>
              <option value=""></option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>8. Finaliza√ß√£o</legend>
        <div class="form-grid">
          <label title="Selecione as fotos segurando a tecla <CTRL> // Tamanho m√°ximo por foto: 1Mb // Tamanho m√°ximo por envio: 20 Mb">Fotos <input id="fotosInput" type="file" name="fotos" accept="image/*" multiple></label>

          <!-- Lista vis√≠vel dos arquivos escolhidos -->
          <div class="full">
            <ul id="listaFotos" style="margin-top: 5px; padding-left: 20px;"></ul>
          </div>

          <label class="full">Outras Informa√ß√µes <textarea name="outrasInformacoes"></textarea></label>
          <label class="full">Sugest√µes <textarea name="sugestoes"></textarea></label>
        </div>
      </fieldset>

      <div class="botoes-container">
        <button type="button" id="saveToSheetButton" >Registrar Ocorr√™ncia</button>
        <button type="button" id="limpaToSheetButton" onclick="limparFormulario()" >Limpar Formul√°rio</button>
      </div>

      <div id="status" class="message"></div>

    </form>

  </div>


<script>

¬† const appScriptUrl = 'https://script.google.com/macros/s/AKfycbxJD52jdpWmVCcchMalcl7MEWj2EwSs22h1SUWA-y4gOsDhum9upjxB0flXMPTMzims/exec';
¬† let lookupData = {};
  let numeroSalvo = '';

¬† const form = document.getElementById('formOcorrencia');
¬† const saveBtn = document.getElementById('saveToSheetButton');
¬† const statusArea = document.getElementById('status');

¬† // Vari√°veis globais para as inst√¢ncias do Choices.js
¬† let recursosChoices = null;
¬† let participacaoChoices = null;

¬† const telInput = document.getElementById('telefoneComunicante');
¬† telInput.addEventListener('input', function () {
¬† ¬† // Remove tudo que n√£o for n√∫mero
¬† ¬† let valor = this.value.replace(/\D/g, '');

¬† ¬† // Limita a 11 d√≠gitos
¬† ¬† valor = valor.substring(0, 11);

¬† ¬† // Aplica a m√°scara
¬† ¬† if (valor.length > 10) {
¬† ¬† ¬† // Formato celular: 00 00000-0000
¬† ¬† ¬† valor = valor.replace(/(\d{2})(\d{5})(\d{1,4})/, "$1 $2-$3");
¬† ¬† } else if (valor.length > 9) {
¬† ¬† ¬† // In√≠cio do formato fixo: 00 0000-0000
¬† ¬† ¬† valor = valor.replace(/(\d{2})(\d{4})(\d{1,4})/, "$1 $2-$3");
¬† ¬† }
¬† ¬† this.value = valor;
¬† });


¬† const latitudeInput = document.getElementById('latitude');
¬† latitudeInput.addEventListener('input', function () {

    // Remove tudo que n√£o for n√∫mero
    let valor = this.value.replace(/\D/g, '');

    // Limita a exatamente 8 d√≠gitos
    valor = valor.substring(0, 8);

    // Aplica a m√°scara quando houver ao menos 1 d√≠gito
    if (valor.length >= 1) {
      valor = valor.replace(/^(\d{0,2})(\d{0,6})$/, function (_, int, dec) {
        if (dec) return `-${int},${dec}`;
        return `-${int}`;
      });
    }
    this.value = valor;
  });


¬† const longitudeInput = document.getElementById('longitude');
¬† longitudeInput.addEventListener('input', function () {

    // Remove tudo que n√£o for n√∫mero
    let valor = this.value.replace(/\D/g, '');

    // Limita a exatamente 8 d√≠gitos
    valor = valor.substring(0, 8);

    // Aplica a m√°scara quando houver ao menos 1 d√≠gito
    if (valor.length >= 1) {
      valor = valor.replace(/^(\d{0,2})(\d{0,6})$/, function (_, int, dec) {
        if (dec) return `-${int},${dec}`;
        return `-${int}`;
      });
    }
    this.value = valor;
  });

  const naturezaSelect = document.getElementById('naturezaDesastreSelect');
  const cobradeSelect = document.getElementById('cobradeSelect');

  naturezaSelect.addEventListener('change', function () {
    const natureza = this.value;

    cobradeSelect.disabled = true;
    cobradeSelect.innerHTML =
      '<option value="">Selecione...</option>';

    if (!natureza) return;

    const lista = lookupData.cobrade?.[natureza];

    if (!lista || lista.length === 0) {
      cobradeSelect.innerHTML =
        '<option value="">Nenhum COBRADE dispon√≠vel</option>';
      return;
    }

    lista.forEach(item => {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      cobradeSelect.appendChild(option);
    });

    cobradeSelect.disabled = false;
  });


  // Mostra a lista de arquivos selecionados no campo Fotos
  document.getElementById('fotosInput').addEventListener('change', function () {
    const lista = document.getElementById('listaFotos');
    lista.innerHTML = ""; // limpa antes

    for (const file of this.files) {
      const li = document.createElement("li");
      li.textContent = file.name;
      lista.appendChild(li);
    }
  });

¬† // Fun√ß√£o para popular selects normais
¬† function populateSelect(selectElement, items) {
¬† ¬† selectElement.innerHTML = '<option value="" disabled selected>Selecione...</option>';

¬† ¬† items.forEach(item => {
¬† ¬† ¬† const option = document.createElement('option');
¬† ¬† ¬† option.value = item;
¬† ¬† ¬† option.textContent = item;
¬† ¬† ¬† selectElement.appendChild(option);
¬† ¬† });
¬† }

¬† // Fun√ß√£o para popular selects com Choices.js
¬† function populateSelectChoices(choicesInstance, items) {
¬† ¬† const list = items.map(i => ({ value: i, label: i }));
¬† ¬† choicesInstance.clearStore();
¬† ¬† choicesInstance.setChoices(list, 'value', 'label', true);
¬† }
¬† 
¬† async function fetchLookupData() {
¬† ¬† const lookupUrl = `${appScriptUrl}?action=lookup`;
¬† ¬† statusArea.textContent = "Carregando dados de apoio...";

¬† ¬† try {
¬† ¬† ¬† const res = await fetch(lookupUrl);
¬† ¬† ¬† const json = await res.json();
¬† ¬† ¬† const data = json.data || json;

¬† ¬† ¬† lookupData = data;

      numeroSalvo = lookupData.numeroOcorrencia;

¬† ¬† ¬† // Popula selects normais
¬† ¬† ¬† if (document.getElementById('municipioOcorrenciaSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('municipioOcorrenciaSelect'), lookupData.municipio || []);

¬† ¬† ¬† if (document.getElementById('repdecSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('repdecSelect'), lookupData.repdec || []);

¬† ¬† ¬† if (document.getElementById('tipoOcorrenciaSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('tipoOcorrenciaSelect'), lookupData.tipoOcorrencia || []);

¬† ¬† ¬† if (document.getElementById('instituicaoSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('instituicaoSelect'), lookupData.instituicaoComunicante || []);

¬† ¬† ¬† if (document.getElementById('naturezaDesastreSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('naturezaDesastreSelect'), lookupData.naturezaDesastre || []);

¬† ¬† ¬† //if (document.getElementById('cobradeSelect'))
¬† ¬† ¬† //¬† populateSelect(document.getElementById('cobradeSelect'), lookupData.cobrade || []);


¬† ¬† ¬† // Inicializa Choices.js para selects m√∫ltiplos e preenche-os
¬† ¬† ¬† if (document.getElementById('recursosSelect') && !recursosChoices) {
¬† ¬† ¬† ¬† recursosChoices = new Choices('#recursosSelect', {
¬† ¬† ¬† ¬† ¬† removeItemButton: true,
¬† ¬† ¬† ¬† ¬† searchPlaceholderValue: "Buscar recurso...",
¬† ¬† ¬† ¬† ¬† placeholderValue: "Selecione...",
¬† ¬† ¬† ¬† ¬† noResultsText: "Nenhum recurso encontrado",
¬† ¬† ¬† ¬† ¬† itemSelectText: "",
¬† ¬† ¬† ¬† });
        // ‚≠ê FECHAR DROPDOWN AP√ìS CADA SELE√á√ÉO
        document.querySelector('#recursosSelect').addEventListener('change', () => {
          recursosChoices.hideDropdown();
        });
        // ‚≠ê MOSTRAR DROPDOWN AO CLICAR NO CAMPO
        const container = document.querySelector('#recursosSelect').closest('.choices');
        container.addEventListener('click', () => {
          recursosChoices.showDropdown();
        });
¬† ¬† ¬† ¬† populateSelectChoices(recursosChoices, lookupData.recursosEmpenhados || []);
¬† ¬† ¬† }

¬† ¬† ¬† if (document.getElementById('participacaoSelect') && !participacaoChoices) {
¬† ¬† ¬† ¬† participacaoChoices = new Choices('#participacaoSelect', {
¬† ¬† ¬† ¬† ¬† removeItemButton: true,
¬† ¬† ¬† ¬† ¬† searchPlaceholderValue: "Buscar institui√ß√£o...",
¬† ¬† ¬† ¬† ¬† placeholderValue: "Selecione...",
¬† ¬† ¬† ¬† ¬† noResultsText: "Nenhuma institui√ß√£o encontrada",
¬† ¬† ¬† ¬† ¬† itemSelectText: "",
¬† ¬† ¬† ¬† });
        // ‚≠ê FECHAR DROPDOWN AP√ìS CADA SELE√á√ÉO
        document.querySelector('#participacaoSelect').addEventListener('change', () => {
          participacaoChoices.hideDropdown();
        });
        // ‚≠ê MOSTRAR DROPDOWN AO CLICAR NO CAMPO
        const container = document.querySelector('#participacaoSelect').closest('.choices');
        container.addEventListener('click', () => {
          participacaoChoices.showDropdown();
        });
¬† ¬† ¬† ¬† populateSelectChoices(participacaoChoices, lookupData.participacaoInstitucional || []);
¬† ¬† ¬† }

¬† ¬† ¬† statusArea.textContent = "‚úÖ Dados carregados com sucesso!";
¬† ¬† ¬† setTimeout(() => { statusArea.textContent = ""; }, 3000);

¬† ¬† } catch (e) {
¬† ¬† ¬† console.error("Falha ao carregar dados de lookup:", e);
¬† ¬† ¬† statusArea.textContent = "‚ùå Erro ao carregar dados de apoio.";
¬† ¬† }

¬† } // Fim de fetchLookupData()


  // Adiciona cada imagem Base64
  const LIMITE_POR_IMAGEM_MB = 2;   // 2 MB por imagem
  const LIMITE_TOTAL_MB = 10;      // 10 MB no total
  async function filesToBase64(files) {
    let totalSize = 0;
    const resultados = [];

    for (const file of files) {
      const sizeMB = file.size / (1024 * 1024);
      if (sizeMB > LIMITE_POR_IMAGEM_MB) {
        throw new Error(`A imagem "${file.name}" excede ${LIMITE_POR_IMAGEM_MB} MB`);
      }
      totalSize += sizeMB;
    }

    if (totalSize > LIMITE_TOTAL_MB) {
      throw new Error(`Tamanho total das imagens excede ${LIMITE_TOTAL_MB} MB`);
    }

    let concluido = 0;

    for (const file of files) {
      const base64 = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });

      resultados.push({
        name: file.name,
        type: file.type,
        data: base64
      });

    }

    return resultados;
  }


  // Forma√ß√£o do n√∫mero da Ocorr√™ncia
  const dataInput = document.querySelector('[name="dataOcorrencia"]');
  const horaInput = document.querySelector('[name="horarioOcorrencia"]');
  const municipioSelect = document.getElementById('municipioOcorrenciaSelect');
  const numeroOcorrenciaInput = document.getElementById('numeroOcorrencia');
  const naturezaDesastre = document.getElementById('naturezaDesastreSelect');

  function normalizarTexto(texto) {
    return texto
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // remove acentos
      .replace(/\s+/g, "")             // remove espa√ßos
      .toUpperCase()
      .substring(0, 3);                // üîπ pega s√≥ as 3 primeiras letras
  }

  function gerarSiglaInteligente(texto) {
    if (!texto) return '';

    // Normaliza texto
    const limpo = texto
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toUpperCase();
 
    const ignoradas = ['DE', 'DO', 'DA', 'DOS', 'DAS', 'E'];

    const palavras = limpo
      .split(/\s+/)
      .filter(p => p && !ignoradas.includes(p));

    if (palavras.length === 0) return '';

    let sigla = '';

    // 1Ô∏è Iniciais das palavras
    for (const p of palavras) {
      sigla += p[0];
      if (sigla.length === 3) break;
    }

    // 2Ô∏è Completa com letras da palavra mais longa
    if (sigla.length < 3) {
      const base = palavras.reduce((a, b) => (b.length > a.length ? b : a));
      let i = 1;
      while (sigla.length < 3 && i < base.length) {
        sigla += base[i];
        i++;
      }
    }

    return sigla.slice(0, 3);
  }

  function gerarNumeroOcorrencia() {
    const data = dataInput.value;
    const hora = horaInput.value;
    const municipio = municipioSelect.value;
    const natureza = naturezaDesastre.value;

    if (!data || !hora || !municipio || !natureza) {
      numeroOcorrenciaInput.value = "";
      return;
    }

    // Data: YYYYMMDD
    const dataFormatada = data.replaceAll("-", "");

    // Hora: HHMM
    const horaFormatada = hora.replace(":", "");

    // Munic√≠pio normalizado
    const municipioFormatado = gerarSiglaInteligente(municipio);

    //const numero = `${dataFormatada}-${horaFormatada}-${municipioFormatado}-${numeroSalvo}`;
    const numero = `${data} - ${hora} - ${municipio} - ${natureza} - ${numeroSalvo}`;

    numeroOcorrenciaInput.value = numero;
  }

  // Atualiza sempre que algum campo mudar
  dataInput.addEventListener('change', gerarNumeroOcorrencia);
  horaInput.addEventListener('change', gerarNumeroOcorrencia);
  municipioSelect.addEventListener('change', gerarNumeroOcorrencia);
  naturezaDesastre.addEventListener('change', gerarNumeroOcorrencia);


  saveBtn.addEventListener('click', async () => {

    // üî∏ Valida√ß√£o autom√°tica dos campos required
    if (!form.checkValidity()) {
      form.reportValidity(); // mostra os erros na tela
      return; // interrompe o envio
    }

    statusArea.textContent = "Enviando Dados da Ocorr√™ncia...";
    saveBtn.disabled = true;

    try {

      const formData = new FormData(form);


      const fotosInput = document.getElementById('fotosInput');

      let fotosBase64 = [];

      if (fotosInput.files.length > 0) {
        fotosBase64 = await filesToBase64(fotosInput.files);
      }

      formData.append('fotosBase64', JSON.stringify(fotosBase64));


      // for√ßa nome em mai√∫sculas
      formData.set('nomeComunicante',
        formData.get('nomeComunicante').toUpperCase()
      );

      // ‚≠ê ALTERADO ‚Äî capturar selecionados do Choices
      const recursosSelecionados = recursosChoices.getValue(true); 
      const participacaoSelecionados = participacaoChoices.getValue(true); 

      // salvar como string separada por v√≠rgula
      formData.set('recursosEmpenhados', recursosSelecionados.join(", "));
      formData.set('participacaoInstitucional', participacaoSelecionados.join(", "));

      // üî∏ Envio de Dados para o Apps Script que precisa identificar a a√ß√£o:
      formData.append('action', 'saveOne');

      const response = await fetch(appScriptUrl, {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (result.status === 'SUCCESS') {
        statusArea.textContent = "‚úÖ Registro salvo!";
        setTimeout(() => { statusArea.textContent = ""; }, 2000);
      } else {
        statusArea.textContent = "‚ö†Ô∏è Erro: " + result.message;
        setTimeout(() => { statusArea.textContent = ""; }, 7000);
      }

    } catch (err) {
      statusArea.textContent = "‚ùå Falha: " + err.message;
    }


    finally {

      saveBtn.disabled = false;

      setTimeout(() => {
        progress.style.display = "none";
        progress.value = 0;
        text.textContent = "";
      }, 2000);

    }

    form.reset();

    // ‚≠ê ADICIONADO ‚Äî limpar visual do Choices tamb√©m
    if (recursosChoices) recursosChoices.removeActiveItems();
    if (participacaoChoices) participacaoChoices.removeActiveItems();
    document.getElementById('listaFotos').innerHTML = "";
    document.getElementById('fotosInput').value = ""; // Tamb√©m limpa o input de arquivo

    //Volta os selects normais para a op√ß√£o "Selecione..."
    const selects = form.querySelectorAll('select');
    selects.forEach(select => {
        if (!select.hasAttribute('multiple')) {
           select.value = "";
        }
    });

  });


  function limparFormulario() {
    const form = document.querySelector('form');
    if (form) {
        form.reset(); // Limpa a maioria dos campos nativos

        // üéØ Corre√ß√£o/Melhoria: Limpar a lista visual de fotos
        document.getElementById('listaFotos').innerHTML = "";
        document.getElementById('fotosInput').value = ""; // Tamb√©m limpa o input de arquivo

        // Limpa visualmente os campos do Choices.js
        if (recursosChoices) recursosChoices.removeActiveItems();
        if (participacaoChoices) participacaoChoices.removeActiveItems();

        // Volta os selects normais para a op√ß√£o "Selecione..."
        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
            if (!select.hasAttribute('multiple')) {
                select.value = "";
            }
        });
    }

  }

¬† // Executa o carregamento dos dados quando o documento estiver pronto
¬† document.addEventListener("DOMContentLoaded", fetchLookupData);

</script>


</body>

</html>
