<!-- FORMUL√ÅRIO DE ATUALIZA√á√ÉO DE DESASTRES -->
<!-- https://defesacivil-es.github.io/Atualizacao-de-Desastres/ -->

<!doctype html>
<html lang="pt-BR">
<head>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Notifica√ß√£o de Desastres - (atualiza√ß√£o)</title>

  <style>
    :root {
      --cor-principal: #2B7A78;
      --cor-secundaria: #DEF2F1;
      --cor-clara: #FEFFFF;
      --cor-escura: #17252A;
    }

    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background-color: var(--cor-secundaria);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      align-items: flex-start;
    }

    /* -- inserir no <style> j√° existente -- */
    .logo {
      width: 100%;            /* ocupa toda a largura poss√≠vel */
      /*max-width: 220px;       /* mas n√£o passa de 220px */
      height: auto;           /* mant√©m a propor√ß√£o */
      display: block;
      margin: 0 auto 12px;    /* centraliza e d√° espa√ßo abaixo */
    }

    .logo-wrap {
      text-align: center;
      margin-bottom: 8px;  /* espa√ßo entre imagem e t√≠tulo */
    }

    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    .container {
      background: var(--cor-clara);
      border-radius: 12px;
      padding: 25px 30px;
      margin: 30px;
      width: 100%;
      max-width: 950px;
      /* min-height: 1300px; /* ajuste conforme necess√°rio */
      height: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    h2 {
      text-align: center;
      color: var(--cor-escura);
      margin-bottom: 20px;
    }

    fieldset {
      border: 2px solid var(--cor-principal);
      border-radius: 8px;
      margin-bottom: 18px;
      padding: 15px 20px;
    }

    legend {
      font-weight: bold;
      color: var(--cor-principal);
      padding: 0 8px;
    }

    label {
      display: block;
      font-size: 14px;
      margin-top: 10px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 4px;
      box-sizing: border-box;
    }

    /* Chrome, Edge, Opera, Safari */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }

    button {
      background-color: var(--cor-principal);
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      /*width: 100%;*/
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #205f5d;
    }

    #buscarOcorrenciaBtn {
      background-color: #6B8E23; /* verde oliva */
      height: 42px;
      margin-top: 23px;
      box-sizing: border-box;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #buscarOcorrenciaBtn:hover {
      background-color: #4F6F1F; /* tom ligeiramente mais escuro no hover */
    }


    #saveToSheetButton {
      background-color: #D2691E; /* laranja opaco */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #saveToSheetButton:hover {
      background-color: #B85C1A; /* tom ligeiramente mais escuro no hover */
    }

    #limpaToSheetButton {
      background-color: #DC143C; /* vermelho */
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      font-size: 16px;
      width: auto; /* <<< largura ajusta ao conte√∫do */
      display: inline-block; /* evita que ocupe 100% do espa√ßo */
    }

    #limpaToSheetButton:hover {
      background-color: #B22222; /* tom ligeiramente mais escuro no hover */
    }

    .full {
      grid-column: 1 / -1; /* faz ocupar toda a linha */
    }

    .half {
      grid-column: span 1;  /* ocupa metade */
    }

    .span-2 {
      grid-column: span 2;
      width: 100%;
    }

    .grid-4 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 16px 20px;
    }

    .grid-4 label {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
   
    .grid-4 :is(input, select) {
      box-sizing: border-box;
    }

    .grid-4 input,
    .grid-4 select,
    .grid-4 button {
     width: 100%;
     height: 40px; /* mesma altura padr√£o dos inputs */
     box-sizing: border-box;
     font: inherit;
    }

    .grid-4 input,
    .grid-4 select,
    .grid-4 textarea {
      line-height: 42px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px 20px;
    }

    .grid-3 label {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
   
    .grid-3 :is(input, select) {
      height: 42px;
      box-sizing: border-box;
    }

    .grid-3 input,
    .grid-3 select,
    .grid-3 textarea {
      line-height: 42px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 20px;
      align-items: end;
    }

    .botoes-container {
      display: flex;
      justify-content: center; /* bot√µes no centro */
      align-items: center;
      gap: 150px;          /* espa√ßo entre os bot√µes */
      width: 100%; /* ocupa toda a largura dispon√≠vel */
      margin-top: 10px;
    }

    #tabelaDonativos {
      width: 100%;  
      max-width: 100%; 
      box-sizing: border-box;
      /* border-collapse: separate !important;  /* permite bordas arredondadas e for√ßa modo separado */
      border-spacing: 0;          /* remove espa√ßamento entre c√©lulas */
      /*border: 2px solid #2B7A78;  /* azul petr√≥leo */
      /*border-radius: 14px;        /* arredonda o contorno da tabela */
      overflow: hidden;           /* garante visual limpo */
    }

    #status {
     text-align: center;
     margin-top: 15px;
     font-weight: bold;
     font-size: 15px;
    }

    .quantidade-container {
     display: flex;
     align-items: center;
     gap: 8px;
    }

    .unidade-label {
     font-weight: bold;
     color: var(--cor-escura);
     white-space: nowrap;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      /*border: 1px solid #ccc;*/
      border: 1px solid #2B7A78;
      padding: 6px;
      text-align: center;
      font-size: 12px;
    }

    th {
      background-color: #87CEEB; /* azul c√©u */
      /*border: 2px solid #2B7A78; /* borda azul petr√≥leo */
      /*border-radius: 8px;        /* arredonda o contorno da tabela */
      color: white;              /* mant√©m o texto branco para contraste */
    }

    .btnExcluir {
      background-color: #c0392b;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      cursor: pointer;
    }

    .btnExcluir:hover {
      background-color: #922b21;
    }

    /* Reduz exatamente a altura do campo */
    .choices {
      width: 100% !important;       /* ocupa apenas a largura da coluna */
      max-width: 100% !important;   /* impede que estoure para fora */
      box-sizing: border-box !important;
      margin-top: 4px !important;
    }

    /* Ajusta a caixa interna para a mesma altura dos outros inputs */
    .choices__inner {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      border: 1px solid #ccc !important;
      border-radius: 6px !important;
      padding: 2px 7px !important;
      min-height: 44px !important;   /* <<< ajuste principal */
      height: auto !important;       /* <<< for√ßa a altura */
      display: flex;
      /* align-items: center;           /* centraliza o texto */
      align-items: flex-start !important;
      flex-wrap: wrap;
    }

    /* Ajusta o texto interno para n√£o aumentar a altura */
    .choices__inner .choices__item {
      padding: 0 !important;
      margin: 0 !important;
      font-size: 14px !important;
      line-height: 1.2 !important;   /* <<< evita expans√£o vertical */
    }

    /* Remove espa√ßo extra no modo single */
    .choices__list--single {
      padding: 0 !important;
    }

    /* Dropdown com altura normal */
    .choices__list--dropdown {
      border-radius: 6px !important;
      border: 1px solid #ccc !important;
      margin-top: 2px !important;
    }

    @media (min-width: 700px) {
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px 20px;
      }
    }

    @media print {
      /* Ocultar bot√µes */
      button, .sem-imprimir {
      display: none !important;
      }

      /* Ajustar largura da p√°gina */
      body {
        margin: 20px;
        font-size: 14px;
      }
    }

    @media print {
      .no-print {
      display: none !important;
      }

      /* Opcional ‚Äî esconder tamb√©m todos os bot√µes */
      /*button { */
      /*display: none !important;*/
      /*}*/
    }    

    /* === CONTAINER PRINCIPAL === */
    .choices, #itensSelect, #itensSelect + .choices {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      overflow: visible !important;
    }

    /* √Årea interna ajust√°vel */
    .choices__inner {
      display: flex !important;
      flex-wrap: wrap !important;
      padding: 8px !important;
      min-height: 44px !important;
      height: auto !important;
    }

    /* === GRID DAS TAGS (4 POR LINHA) === */
    .choices__list--multiple {
      display: grid !important;
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 8px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }

    /* Apar√™ncia das tags */
    .choices__list--multiple .choices__item {
      width: 100% !important;
      text-align: center !important;
      margin: 0 !important;
      padding: 4px 8px !important;
      font-size: 13px !important;
      border-radius: 6px !important;
      box-sizing: border-box !important;
    }

    /* === CENTRALIZA√á√ÉO DO PLACEHOLDER REAL === */
    .choices[data-type*="select-multiple"] 
    .choices__list--single 
    .choices__placeholder {
      width: 100% !important;
      text-align: center !important;
      display: block !important;
      margin: 0 auto !important;
    }

    /* Cor de fundo dos campos desabilitados */
    input:disabled,
    select:disabled,
    textarea:disabled {
      background-color: #e0e0e0; /* cinza mais escuro */
      color: #555;              /* texto mais apagado */
      cursor: not-allowed;      /* cursor de campo bloqueado */
    }
   
    #numeroOcorrenciaSelect {
      background-color: #d4f5d4;
      font-weight: bold;
      color: #000;
    }

    input:read-only,
    textarea:read-only,
    select:disabled {
      background-color: #f0f0f0; /* cinza claro */
      color: #555;               /* texto levemente mais escuro */
      cursor: not-allowed;
    }

    .message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
  
      background: #ffffff;
      color: #E74C3C;
      padding: 16px 24px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  
      z-index: 9999;
      max-width: 400px;
      text-align: center;

      display: none; /* come√ßa escondido */
    }

    #limparFiltroBtn {
     margin-top: 22px;
    }

  </style>

</head>

<body>

  <div class="container">
    <div class="logo-wrap">
      <img src="Logo_CEPDEC.PNG" alt="Logo da CEPDEC" class="logo">
    </div>

    <h2>Atualiza√ß√£o de Dados de Ocorr√™ncias e Desastres</h2>

    <form id="formOcorrencia">

      <fieldset style= "border: none; display:flex; justify-content:center; text-align: center;" >
          <label style= "color: #0047AB; font-size: 16px; font-weight: bold;" >::: Preencha os campos na sequ√™ncia em que s√£o apresentados com especial aten√ß√£o aos campos obrigat√≥rios (*) :::</label>
      </fieldset>

      <fieldset style= "border: none; display:flex; justify-content:center; text-align: center;" >
        <div>
          <label style= "color: #0047AB; font-size: 16px; font-weight: bold;" >Selecione o Tipo de Respons√°vel pelo Registro</label>
          <select id="responsavelSelect" name="responsavel" >
            <option value="plantonista" selected>Plantonista CEPDEC</option>
            <option value="comunicante">Operador da Defesa Civil Municipal</option>
          </select>
        </div>
      </fieldset>

      <fieldset style= "border: none; display:flex; justify-content:center; text-align: center;" >
        <legend>Preencha os Campos de Busca para Filtrar e/ou Procure na Lista "N√∫mero da Ocorr√™ncia"</legend>
        <div class="grid-4">
          <label>Data inicial
            <input type="date" id="filtroDataInicio">
          </label>
          <label>Data final
            <input type="date" id="filtroDataFim">
          </label>
          <label>Munic√≠pio
            <select id="filtroMunicipio" name="municipiosRegistrados" >
              <option value="">Selecione...</option>
            </select>
          </label>
          <label><button class="botoes-container" type="button" id="limparFiltroBtn" >Limpar filtro</button></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>1. Identifica√ß√£o da Ocorr√™ncia</legend>
        <div class="grid-3">
          <label title= "Escolha uma ocorr√™ncia j√° cadastrada para atualiz√°-la" class = "full">N√∫mero da Ocorr√™ncia *
            <select id="numeroOcorrenciaSelect" name="numeroOcorrencia" required>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>

          <label>Tipo de Ocorr√™ncia <input type="text" name="tipoOcorrencia" readonly ></label>
          <label>Data da Ocorr√™ncia <input id= "dataOcorrencia" type="date" name="dataOcorrencia" readonly ></label>
          <label>Hor√°rio da Ocorr√™ncia <input id="horarioOcorrencia" type="time" name="horarioOcorrencia" readonly ></label>
        </div>
      </fieldset>
      
      <fieldset id="fieldsetPlantonista" >
        <legend>2. Identifica√ß√£o do Comunicante</legend>
        <div class="grid-3">
          <label class="span-2">Plantonista CEPDEC *
            <select id="plantonistaSelect" name="plantonista" required>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>N√∫mero Funcional * <input id="numeroFuncional" name="numeroFuncional" type="text" maxlength="7" inputmode="numeric" required></label>
          <label class="full">Fontes de Informa√ß√£o Utilizadas para o Registro  (OBS: n√£o excluir as j√° catalogadas, exceto para efeito de corre√ß√£o.)
            <select id="fontesInformacaoSelect" name="fontesInformacao" multiple>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
        </div>
      </fieldset>

      <fieldset id="fieldsetComunicante" style="display:none">
        <legend>2. Identifica√ß√£o do Comunicante</legend>
        <div class="grid-3">
          <label>REPDEC - Respons√°vel *
            <select id="repdecSelect" name="repdec">
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Institui√ß√£o Comunicante *
            <select id="instituicaoSelect" name="instituicaoComunicante">
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Senha * <input id= "senha" type="text" name="senha"></label>
          <label>Nome do Comunicante * <input type="text" id="nomeComunicante" name="nomeComunicante" style="text-transform: uppercase;"></label>
          <label>Telefone do Comunicante * <input id="telefoneComunicante" name="telefoneComunicante" type="text" maxlength="13" inputmode="numeric" placeholder="00 00000-0000"></label>
          <label>E-mail do Comunicante * <input type="email" id="emailComunicante" name="emailComunicante"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>3. Localiza√ß√£o da Ocorr√™ncia</legend>
        <div class="grid-3">
          <label>Munic√≠pio <input type="text" name="municipioOcorrencia" readonly ></label>
          <label>Bairro <input type="text" name="bairro" readonly ></label>
          <label>Rua <input type="text" name="rua" readonly ></label>
          <label>N√∫mero <input type="number" name="numero" readonly ></label>
          <label>Complemento <input type="text" name="complemento" readonly ></label>
          <label>Ponto de Refer√™ncia <input type="text" name="pontoReferencia" readonly ></label>
          <label title= "Digite apenas os n√∫meros">Latitude - (Ex: -20,985815) <input id="latitude" type="text" name="latitude" maxlength="10" inputmode="numeric" placeholder="-00,000000" readonly ></label>
          <label title= "Digite apenas os n√∫meros">Longitude - (Ex: -40,985815) <input id="longitude" type="text" name="longitude" maxlength="10" inputmode="numeric" placeholder="-00,000000" readonly ></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>4. Descri√ß√£o da Ocorr√™ncia</legend>
        <div class="grid-3">

          <label>Natureza do Desastre <input type="text" name="naturezaDesastre" readonly ></label>

          <label class = "span-2">COBRADE <input type="text" name="cobrade" readonly ></label>

          <label class = "span-2">Rio ou C√≥rrego Pr√≥ximo <input type="text" name="rioCorregro" ></label>
          <label  title="Informe a cota m√°xima de inunda√ß√£o atingida nas casas (em metros)!">Cota M√°xima de Inunda√ß√£o (mts) <input type="number" id="cotaMaxima" name="cotaMaxima" inputmode="decimal" step="0.01"></label>
          <label class = "full">Relato de Estrutura Colapsada <textarea name="relatoEstruturaColapsada" ></textarea></label>
          <label class = "full">Relato Detalhado da Ocorr√™ncia * <textarea name="relatoDetalhadoOcorrencia" required></textarea></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>5. Total de Danos e Preju√≠zos Humanos</legend>
        <div class="grid-3">
          <label>Desalojados <input type="number" id="desalojados" name="desalojados" min="0"></label>
          <label>Desabrigados <input type="number" id="desabrigados" name="desabrigados" min="0"></label>
          <label>Feridos <input type="number" id="feridos" name="feridos" min="0"></label>
          <label>Enfermos <input type="number" id="enfermos" name="enfermos" min="0"></label>
          <label>Desaparecidos <input type="number" id="desaparecidos" name="desaparecidos" min="0"></label>
          <label>√ìbitos <input type="number" id="obitos" name="obitos" min="0"></label>
          <label>Outras Pessoas Afetadas <input type="number" id="outrasAfetadas" name="outrasAfetadas" min="0"></label>
          <label>Pessoas Encaminhadas para Abrigo <input type="number" id="pessoasAbrigo" name="pessoasAbrigo" min="0"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>6. Total de Danos e Preju√≠zos Materiais</legend>
        <div class="grid-3">
          <label>Unidades Habitacionais Afetadas <input type="number" id="unidHabitAfetadas" name="unidHabitAfetadas" min="0"></label>
          <label>Instala√ß√µes Particulares Afetadas <input type="number" id="instPartAfetadas" name="instPartAfetadas" min="0"></label>
          <label>Instala√ß√µes P√∫blicas Afetadas <input type="number" id="instPublAfetadas" name="instPublAfetadas" min="0"></label>
          <label>Vias interditadas <input type="number" id="viasInterditadas" name="viasInterditadas" min="0"></label>
          <label>Infraestruturas P√∫blicas Afetadas <input type="number" id="infraPublAfetadas" name="infraPublAfetadas" min="0"></label>
        </div>
      </fieldset>

      <fieldset>
        <legend>7. Confer√™ncia e Atualiza√ß√£o dos Dados de Participa√ß√£o Institucional e A√ß√µes Adotadas </legend>
        <div class="grid-3">
          <label class="full">Rela√ß√£o de Recursos Empenhados no Desastre  (OBS: n√£o excluir os j√° catalogados, exceto para efeito de corre√ß√£o.)
            <select id="recursosSelect" name="recursosEmpenhados" multiple>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label class="full">Participa√ß√£o Institucional  (OBS: n√£o excluir os j√° catalogados, exceto para efeito de corre√ß√£o.)
            <select id="participacaoSelect" name="participacaoInstitucional" multiple>
              <option value="" disabled selected>Carregando...</option>     
            </select>
          </label>
          <label>Total de Servidores Volunt√°rios Atuando pelo Munic√≠pio <input type="number" name="servidoresVoluntarios" min="0"></label>
          <label>Ativado SCO com a instala√ß√£o de um PC Local no Munic√≠pio? *
            <select id="ativacaoSCO" name="ativacaoSCO" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o munic√≠pio emitiu ou emitir√° decreto de situa√ß√£o de anormalidade!">O Munic√≠pio Emitiu ou Emitir√° Decreto de Situa√ß√£o de Anormalidade? *
            <select id="emissaoDecreto" name="emissaoDecreto" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o munic√≠pio necessita de apoio para o restabelecimento de servi√ßos essenciais!">O Munic√≠pio Necessita de Apoio? *
            <select id="necessitaApoio" name="necessitaApoio" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o munic√≠pio solicitou ou solicitar√° Itens de Assist√™ncia Humanit√°ria da CEPDEC!">Solicita√ß√£o de IAH √† CEPDEC? *
            <select id="solicitaIAH" name="solicitaIAH" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o foi Instalado Posto de Comando!">Houve Instala√ß√£o de Posto Comando? *
            <select id="postoComando" name="postoComando" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o foi Instalado Abrigo!">Houve Instala√ß√£o de Abrigo? *
            <select id="instalacaoAbrigo" name="instalacaoAbrigo" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
          <label title="Informe se o foi Instalado Centro de Log√≠stica Humanit√°ria!">Houve Instala√ß√£o de Centro Log√≠stica? *
            <select id="centroLogistica" name="centroLogistica" required>
              <option selected>N√£o informado</option>
              <option>Sim</option>
              <option>N√£o</option>
            </select>
          </label>
        </div>
      </fieldset>

      <fieldset>
        <legend>8. Finaliza√ß√£o</legend>
        <div class="form-grid">
          <label title="Selecione as fotos segurando a tecla <CTRL> // Tamanho m√°ximo por foto: 1Mb // Tamanho m√°ximo por envio: 20 Mb">Inclua Novas Fotos <input id="fotosInput" type="file" name="fotos" accept="image/*" multiple></label>

          <!-- Lista vis√≠vel dos arquivos escolhidos -->
          <div class="full">
            <ul id="listaFotos" style="margin-top: 5px; padding-left: 20px;"></ul>
          </div>

          <label class="full">Outras Informa√ß√µes <textarea id="outrasInformacoes" name="outrasInformacoes" ></textarea></label>
          <label class="full">Sugest√µes <textarea id="sugestoes" name="sugestoes" ></textarea></label>
        </div>
      </fieldset>

      <div class="botoes-container">
        <button type="button" id="saveToSheetButton" >Registrar Ocorr√™ncia</button>
        <button type="button" id="limpaToSheetButton" onclick="limparFormulario()" >Limpar Formul√°rio</button>
      </div>

      <div id="status" class="message"></div>

    </form>

  </div>


<script>

¬† const appScriptUrl = 'https://script.google.com/macros/s/AKfycbwU1QnO2qJGOjDR6aFXK7gqwFCgvCJ_pVrwWOOD0jOgW8_fo1CGnpXqq1_i9cZoP8D1/exec';

¬† const form = document.getElementById('formOcorrencia');

¬† let lookupData = {};

¬† // Vari√°veis globais para as inst√¢ncias do Choices.js
¬† let recursosChoices = null;
¬† let participacaoChoices = null;
¬† let fontesInformacaoChoices = null;


¬† //////////////////////////////////// ***** FUN√á√ÉO fetch ***** ////////////////////////////////////
 
¬† async function fetchLookupData() {
¬† ¬† const lookupUrl = `${appScriptUrl}?action=lookup`;
¬† ¬† mostrarStatus("Carregando dados de apoio...", 0);

¬† ¬† try {
¬† ¬† ¬† const res = await fetch(lookupUrl);
¬† ¬† ¬† const json = await res.json();
¬† ¬† ¬† const data = json.data || json;

¬† ¬† ¬† lookupData = data;

¬† ¬† ¬† // ***** Popula selects normais ***** //

¬† ¬† ¬† //if (document.getElementById('municipioOcorrenciaSelect'))
¬† ¬† ¬† //¬† populateSelect(document.getElementById('municipioOcorrenciaSelect'), lookupData.municipio || []);

      if (document.getElementById('filtroMunicipio'))
        populateSelect(document.getElementById('filtroMunicipio'), lookupData.municipiosRegistrados || []);

¬† ¬† ¬† if (document.getElementById('numeroOcorrenciaSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('numeroOcorrenciaSelect'), lookupData.numeroOcorrencia || []);

¬† ¬† ¬† if (document.getElementById('repdecSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('repdecSelect'), lookupData.repdec || []);

¬† ¬† ¬† if (document.getElementById('plantonistaSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('plantonistaSelect'), lookupData.plantonista || []);

¬† ¬† ¬† //if (document.getElementById('tipoOcorrenciaSelect'))
¬† ¬† ¬† //¬† populateSelect(document.getElementById('tipoOcorrenciaSelect'), lookupData.tipoOcorrencia || []);

¬† ¬† ¬† if (document.getElementById('instituicaoSelect'))
¬† ¬† ¬† ¬† populateSelect(document.getElementById('instituicaoSelect'), lookupData.instituicaoComunicante || []);

¬† ¬† ¬† //if (document.getElementById('naturezaDesastreSelect'))
¬† ¬† ¬† //¬† populateSelect(document.getElementById('naturezaDesastreSelect'), lookupData.naturezaDesastre || []);

¬† ¬† ¬† //if (document.getElementById('cobradeSelect'))
¬† ¬† ¬† //¬† populateSelect(document.getElementById('cobradeSelect'), lookupData.cobrade || []);

¬† ¬† ¬† // ***** Inicializa Choices.js para selects m√∫ltiplos e preenche-os ***** //

¬† ¬† ¬† if (document.getElementById('recursosSelect') && !recursosChoices) {
¬† ¬† ¬† ¬† recursosChoices = new Choices('#recursosSelect', {
¬† ¬† ¬† ¬† ¬† removeItemButton: true,
¬† ¬† ¬† ¬† ¬† searchPlaceholderValue: "Buscar recurso...",
¬† ¬† ¬† ¬† ¬† placeholderValue: "Selecione...",
¬† ¬† ¬† ¬† ¬† noResultsText: "Nenhum recurso encontrado",
¬† ¬† ¬† ¬† ¬† itemSelectText: "",
¬† ¬† ¬† ¬† });
        // ‚≠ê FECHAR DROPDOWN AP√ìS CADA SELE√á√ÉO
        document.querySelector('#recursosSelect').addEventListener('change', () => {
          recursosChoices.hideDropdown();
        });
        // ‚≠ê MOSTRAR DROPDOWN AO CLICAR NO CAMPO
        const container = document.querySelector('#recursosSelect').closest('.choices');
        container.addEventListener('click', () => {
          recursosChoices.showDropdown();
        });
¬† ¬† ¬† ¬† populateSelectChoices(recursosChoices, lookupData.recursosEmpenhados || []);
¬† ¬† ¬† }

¬† ¬† ¬† if (document.getElementById('participacaoSelect') && !participacaoChoices) {
¬† ¬† ¬† ¬† participacaoChoices = new Choices('#participacaoSelect', {
¬† ¬† ¬† ¬† ¬† removeItemButton: true,
¬† ¬† ¬† ¬† ¬† searchPlaceholderValue: "Buscar institui√ß√£o...",
¬† ¬† ¬† ¬† ¬† placeholderValue: "Selecione...",
¬† ¬† ¬† ¬† ¬† noResultsText: "Nenhuma institui√ß√£o encontrada",
¬† ¬† ¬† ¬† ¬† itemSelectText: "",
¬† ¬† ¬† ¬† });
        // ‚≠ê FECHAR DROPDOWN AP√ìS CADA SELE√á√ÉO
        document.querySelector('#participacaoSelect').addEventListener('change', () => {
          participacaoChoices.hideDropdown();
        });
        // ‚≠ê MOSTRAR DROPDOWN AO CLICAR NO CAMPO
        const container = document.querySelector('#participacaoSelect').closest('.choices');
        container.addEventListener('click', () => {
          participacaoChoices.showDropdown();
        });
¬† ¬† ¬† ¬† populateSelectChoices(participacaoChoices, lookupData.participacaoInstitucional || []);
¬† ¬† ¬† }

¬† ¬† ¬† if (document.getElementById('fontesInformacaoSelect') && !fontesInformacaoChoices) {
¬† ¬† ¬† ¬† fontesInformacaoChoices = new Choices('#fontesInformacaoSelect', {
¬† ¬† ¬† ¬† ¬† removeItemButton: true,
¬† ¬† ¬† ¬† ¬† searchPlaceholderValue: "Buscar fonte...",
¬† ¬† ¬† ¬† ¬† placeholderValue: "Selecione...",
¬† ¬† ¬† ¬† ¬† noResultsText: "Nenhuma fonte de informa√ß√£o encontrada",
¬† ¬† ¬† ¬† ¬† itemSelectText: "",
¬† ¬† ¬† ¬† });
        // ‚≠ê FECHAR DROPDOWN AP√ìS CADA SELE√á√ÉO
        document.querySelector('#fontesInformacaoSelect').addEventListener('change', () => {
          fontesInformacaoChoices.hideDropdown();
        });
        // ‚≠ê MOSTRAR DROPDOWN AO CLICAR NO CAMPO
        const container = document.querySelector('#fontesInformacaoSelect').closest('.choices');
        container.addEventListener('click', () => {
          fontesInformacaoChoices.showDropdown();
        });
¬† ¬† ¬† ¬† populateSelectChoices(fontesInformacaoChoices, lookupData.fontesInformacao || []);
¬† ¬† ¬† }

¬† ¬† ¬† mostrarStatus("‚úÖ Dados carregados com sucesso!", 1500);

¬† ¬† } catch (e) {
¬† ¬† ¬† console.error("Falha ao carregar dados de lookup:", e);
¬† ¬† ¬† mostrarStatus("‚ùå Erro ao carregar dados de apoio.", 3000);
¬† ¬† }

    /// *** PROMOVE A BUSCA DOS DADOS A PARTIR DA SELE√á√ÉO DE UM N√öMERO DE OCORR√äNCIA *** ///  
    const select = document.getElementById("numeroOcorrenciaSelect");
    if (select) {
      select.addEventListener("change", buscaDadosPreencheFormulario);
    }

¬† } // Fim de fetchLookupData()


  //////////////////////////////////// ***** FORMATA E ORGANIZA OS DADOS DO FORMUL√ÅRIO ***** ////////////////////////////////////

¬† const telInput = document.getElementById('telefoneComunicante');
¬† telInput.addEventListener('input', function () {
¬† ¬† // Remove tudo que n√£o for n√∫mero
¬† ¬† let valor = this.value.replace(/\D/g, '');

¬† ¬† // Limita a 11 d√≠gitos
¬† ¬† valor = valor.substring(0, 11);

¬† ¬† // Aplica a m√°scara
¬† ¬† if (valor.length > 10) {
¬† ¬† ¬† // Formato celular: 00 00000-0000
¬† ¬† ¬† valor = valor.replace(/(\d{2})(\d{5})(\d{1,4})/, "$1 $2-$3");
¬† ¬† } else if (valor.length > 9) {
¬† ¬† ¬† // In√≠cio do formato fixo: 00 0000-0000
¬† ¬† ¬† valor = valor.replace(/(\d{2})(\d{4})(\d{1,4})/, "$1 $2-$3");
¬† ¬† }
¬† ¬† this.value = valor;
¬† });

¬† const latitudeInput = document.getElementById('latitude');
¬† latitudeInput.addEventListener('input', function () {

    // Remove tudo que n√£o for n√∫mero
    let valor = this.value.replace(/\D/g, '');

    // Limita a exatamente 8 d√≠gitos
    valor = valor.substring(0, 8);

    // Aplica a m√°scara quando houver ao menos 1 d√≠gito
    if (valor.length >= 1) {
      valor = valor.replace(/^(\d{0,2})(\d{0,6})$/, function (_, int, dec) {
        if (dec) return `-${int},${dec}`;
        return `-${int}`;
      });
    }
    this.value = valor;
  });

¬† const longitudeInput = document.getElementById('longitude');
¬† longitudeInput.addEventListener('input', function () {

    // Remove tudo que n√£o for n√∫mero
    let valor = this.value.replace(/\D/g, '');

    // Limita a exatamente 8 d√≠gitos
    valor = valor.substring(0, 8);

    // Aplica a m√°scara quando houver ao menos 1 d√≠gito
    if (valor.length >= 1) {
      valor = valor.replace(/^(\d{0,2})(\d{0,6})$/, function (_, int, dec) {
        if (dec) return `-${int},${dec}`;
        return `-${int}`;
      });
    }
    this.value = valor;
  });

  // Mostra a lista de arquivos selecionados no campo Fotos
  document.getElementById('fotosInput').addEventListener('change', function () {
    const lista = document.getElementById('listaFotos');
    lista.innerHTML = ""; // limpa antes
    for (const file of this.files) {
      const li = document.createElement("li");
      li.textContent = file.name;
      lista.appendChild(li);
    }
  });

¬† // Fun√ß√£o para popular selects normais
¬† function populateSelect(selectElement, items) {
¬† ¬† selectElement.innerHTML = '<option value="" disabled selected>Selecione...</option>';
¬† ¬† items.forEach(item => {
¬† ¬† ¬† const option = document.createElement('option');
¬† ¬† ¬† option.value = item;
¬† ¬† ¬† option.textContent = item;
¬† ¬† ¬† selectElement.appendChild(option);
¬† ¬† });
¬† }

¬† // Fun√ß√£o para popular selects com Choices.js
¬† function populateSelectChoices(choicesInstance, items) {
¬† ¬† const list = items.map(i => ({ value: i, label: i }));
¬† ¬† choicesInstance.clearStore();
¬† ¬† choicesInstance.setChoices(list, 'value', 'label', true);
¬† }

  /// *** MOSTRA AS MENSAGENS *** ///
  let statusTimeout = null;
¬† const statusArea = document.getElementById('status');
  function mostrarStatus(mensagem, tempo = 3000) {
    // ‚õî Cancela timeout anterior
    if (statusTimeout) {
      clearTimeout(statusTimeout);
      statusTimeout = null;
    }

    statusArea.textContent = mensagem;
    statusArea.style.display = "block";

    if (tempo > 0) {
      statusTimeout = setTimeout(() => {
        statusArea.style.display = "none";
        statusArea.textContent = '';
        statusTimeout = null;
      }, tempo);
    }
  }

  /// *** VOLTA AO TOPO DO FORMUL√ÅRIO *** ///
  function voltarAoTopo() {
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  }


  //////////////////////////////////// ***** LIMPA E PREPARA O AMBIENTE DO FORMUL√ÅRIO ***** ////////////////////////////////////

  /// *** LIMPA O FORMUL√ÅRIO *** ///
  function limparFormulario() {
    const form = document.querySelector('form');
    if (form) {

        const dataInicio = document.getElementById("filtroDataInicio").value;
        const dataFim = document.getElementById("filtroDataFim").value;
        const municipio = document.getElementById("filtroMunicipio").value;

        form.reset(); // Limpa a maioria dos campos nativos

        // üéØ Corre√ß√£o/Melhoria: Limpar a lista visual de fotos
        document.getElementById('listaFotos').innerHTML = "";
        document.getElementById('fotosInput').value = ""; // Tamb√©m limpa o input de arquivo

        // Limpa visualmente os campos do Choices.js
        if (recursosChoices) recursosChoices.removeActiveItems();
        if (participacaoChoices) participacaoChoices.removeActiveItems();
        if (fontesInformacaoChoices) fontesInformacaoChoices.removeActiveItems();

        // Volta os selects normais para a op√ß√£o "Selecione..."
        const selects = form.querySelectorAll('select');
        selects.forEach(select => {
            if (!select.hasAttribute('multiple')) {
                select.value = "";
            }
        });

        // Mantem os dados do filtro
        document.getElementById("filtroDataInicio").value = dataInicio;
        document.getElementById("filtroDataFim").value = dataFim;
        document.getElementById("filtroMunicipio").value = municipio;
    }

    document.getElementById('responsavelSelect').value = 'plantonista';
    document.getElementById("responsavelSelect").dispatchEvent(new Event("change"));

    document.getElementById("ativacaoSCO").selectedIndex = 0;
    document.getElementById("emissaoDecreto").selectedIndex = 0;
    document.getElementById("necessitaApoio").selectedIndex = 0;
    document.getElementById("solicitaIAH").selectedIndex = 0;
    document.getElementById("postoComando").selectedIndex = 0;
    document.getElementById("instalacaoAbrigo").selectedIndex = 0;
    document.getElementById("centroLogistica").selectedIndex = 0;

    voltarAoTopo()

  }

  /// *** LIMPA FILTRO DE BUSCA *** ///
  const limparBtn = document.getElementById('limparFiltroBtn');
  limparBtn.addEventListener('click', async () => {
    document.getElementById("filtroDataInicio").value = "";
    document.getElementById("filtroDataFim").value = "";
    document.getElementById("filtroMunicipio").value = "";
    populateSelect(document.getElementById('numeroOcorrenciaSelect'), lookupData.numeroOcorrencia || []);

    limparFormulario()

  });      

  /// *** CONECTAR EVENTOS DOS FILTROS *** ///
  function configurarFiltroOcorrencias() {
    const dataInicio = document.getElementById("filtroDataInicio");
    const dataFim = document.getElementById("filtroDataFim");
    const municipio = document.getElementById("filtroMunicipio");

    if (!dataInicio || !dataFim || !municipio) return;

    dataInicio.addEventListener("change", carregarOcorrenciasFiltradas);
    dataFim.addEventListener("change", carregarOcorrenciasFiltradas);
    municipio.addEventListener("change", carregarOcorrenciasFiltradas);
  }

  /// *** CARREGA N√öMERO DE OCORR√äNCIAS CONFORME O FILTRO *** ///
  async function carregarOcorrenciasFiltradas() {
    const dataInicio = document.getElementById("filtroDataInicio").value;
    const dataFim = document.getElementById("filtroDataFim").value;
    const municipio = document.getElementById("filtroMunicipio").value;

    const numeroSelect = document.getElementById("numeroOcorrenciaSelect");

    // S√≥ executa quando tudo estiver preenchido
    if (!dataInicio || !dataFim || !municipio) {
      //if (numeroSelect) numeroSelect.innerHTML = '<option value="">Selecione...</option>';
      return;
    }

    mostrarStatus("üîé Buscando ocorr√™ncias filtradas...", 0);

    try {
      const params = new URLSearchParams({
        action: "getOcorrenciasFiltradas",
        dataInicio,
        dataFim,
        municipio
      });

      const resposta = await fetch(`${appScriptUrl}?${params.toString()}`);
      const json = await resposta.json();

      if (json.status !== "SUCCESS") {
        mostrarStatus("‚ö†Ô∏è " + (json.message || "Erro ao buscar ocorr√™ncias"), 3000);
        return;
      }

      preencherSelectNumero(json.data || []);

      limparFormulario()

      // Mantem os dados do filtro
      document.getElementById("filtroDataInicio").value = dataInicio;
      document.getElementById("filtroDataFim").value = dataFim;
      document.getElementById("filtroMunicipio").value = municipio;  

      mostrarStatus("‚úÖ Ocorr√™ncias carregadas", 1500);

    } catch (erro) {
      console.error("Erro ao buscar ocorr√™ncias filtradas:", erro);
      mostrarStatus("‚ùå Falha na comunica√ß√£o com o servidor", 3000);
    }
  }

  /// *** POPULA O SELECT DE OCORR√äNCIAS CONFORME O FILTRO *** ///
  function preencherSelectNumero(lista) {
    const select = document.getElementById("numeroOcorrenciaSelect");
    if (!select) return;

    select.innerHTML = '<option value="" disabled selected>Selecione...</option>';

    lista.forEach(numero => {
      const opt = document.createElement("option");
      opt.value = numero;
      opt.textContent = numero;
      select.appendChild(opt);
    });
  }


  //////////////////////////////////// ***** RECUPERA DADOS DA OCORR√äNCIA PARA EDI√á√ÉO ***** ////////////////////////////////////

  /// *** BUSCA OS DADOS REFERENTES AO N√öMERO DA OCORR√äNCIA *** ///
  const numeroSelect = document.getElementById('numeroOcorrenciaSelect');
  let abortBuscaOcorrencia = null;
  async function buscaDadosPreencheFormulario() {
    const numero = numeroSelect.value;
    const dataInicio = document.getElementById("filtroDataInicio").value;
    const dataFim = document.getElementById("filtroDataFim").value;
    const municipio = document.getElementById("filtroMunicipio").value;

    // Limpa qualquer status anterior
    mostrarStatus('', 0);
      
    if (!numero) {
      mostrarStatus("‚ö†Ô∏è Selecione um n√∫mero de ocorr√™ncia", 3000);
      return;
    }

    // Cancela busca em andamento, se existir
    if (abortBuscaOcorrencia) {
      abortBuscaOcorrencia.abort();
      abortBuscaOcorrencia = null;
    }

    // Limpa formul√°rio
    limparFormulario();

    // Garante que o n√∫mero continue selecionado
    numeroSelect.value = numero;

    // Mantem os dados do filtro
    document.getElementById("filtroDataInicio").value = dataInicio;
    document.getElementById("filtroDataFim").value = dataFim;
    document.getElementById("filtroMunicipio").value = municipio;     
      
    abortBuscaOcorrencia = new AbortController();
    const { signal } = abortBuscaOcorrencia;

    mostrarStatus("üîé Buscando ocorr√™ncia...", 0);
    form.classList.add('loading');

    try {
      const res = await fetch(
        `${appScriptUrl}?action=getByNumero&numeroOcorrencia=${encodeURIComponent(numero)}`,
        { signal }
      );

      const json = await res.json();

      if (json.status !== 'SUCCESS') {
        mostrarStatus("‚ö†Ô∏è " + json.message, 5000);
        return;
      }

      preencherFormulario(json.data);
      mostrarStatus("‚úÖ Ocorr√™ncia carregada", 3000);

    } catch (err) {
      if (err.name !== 'AbortError') {
        console.error(err);
        mostrarStatus("‚ùå Erro ao buscar ocorr√™ncia", 5000);
      }
    } finally {
      form.classList.remove('loading');
    }
  }

  /// *** PREENCHE O FORMUL√ÅRIO COM OS DADOS ENCONTRADOS *** ///
  function preencherFormulario(dados) {
    Object.keys(dados).forEach(name => {
      const field = form.querySelector(`[name="${name}"]`);
      if (!field) return;

      // SELECT m√∫ltiplo com Choices
      if (field.multiple && (name === 'recursosEmpenhados' || name === 'participacaoInstitucional' || name === 'fontesInformacao')) {
        const valores = String(dados[name]).split(',').map(v => v.trim());

        if (name === 'recursosEmpenhados' && recursosChoices) {
          recursosChoices.removeActiveItems();
          recursosChoices.setChoiceByValue(valores);
        }

        if (name === 'participacaoInstitucional' && participacaoChoices) {
          participacaoChoices.removeActiveItems();
          participacaoChoices.setChoiceByValue(valores);
        }

        if (name === 'fontesInformacao' && fontesInformacaoChoices) {
          fontesInformacaoChoices.removeActiveItems();
          fontesInformacaoChoices.setChoiceByValue(valores);
        }

        return;
      }

      // SELECT normal
      if (field.tagName === 'SELECT') {
        field.value = dados[name];
        return;
      }

      // INPUT / TEXTAREA
      field.value = dados[name] ?? '';

    });

    document.getElementById('dataOcorrencia').value =
      formatarDataParaInput(dados.dataOcorrencia);

    document.getElementById('horarioOcorrencia').value =
      formatarHoraParaInput(dados.horarioOcorrencia);

    document.getElementById('latitude').value = formatarLatitudeLongitude(dados.latitude);
    document.getElementById('longitude').value = formatarLatitudeLongitude(dados.longitude);

    document.getElementById('plantonistaSelect').value = "";
    document.getElementById('numeroFuncional').value = "";
    //document.getElementById('fontesInformacaoSelect').value = "";
    document.getElementById('repdecSelect').value = "";
    document.getElementById('instituicaoSelect').value = "";
    document.getElementById('nomeComunicante').value = "";
    document.getElementById('telefoneComunicante').value = "";
    document.getElementById('emailComunicante').value = "";

    //document.getElementById('cotaMaxima').value = "" ;
    //document.getElementById('desalojados').value = "";
    //document.getElementById('desabrigados').value = "";
    //document.getElementById('feridos').value = "";
    //document.getElementById('enfermos').value = "";
    //document.getElementById('desaparecidos').value = "";
    //document.getElementById('obitos').value = "";   
    //document.getElementById('outrasAfetadas').value = "";
    //document.getElementById('pessoasAbrigo').value = "";
    //document.getElementById('unidHabitAfetadas').value = "";
    //document.getElementById('instPartAfetadas').value = "";
    //document.getElementById('instPublAfetadas').value = "";
    //document.getElementById('viasInterditadas').value = "";    
    //document.getElementById('infraPublAfetadas').value = "";   
    //document.getElementById('outrasInformacoes').value = "";    
    //document.getElementById('sugestoes').value = "";     

  }

  /// *** FORMATA A LATITUDE E A LONGITUDE *** ///
  function formatarLatitudeLongitude(numerotexto) {

    if (!numerotexto) return '';

    // Remove tudo que n√£o for n√∫mero
    let valor = String(numerotexto).replace(/\D/g, '');

    // Limita a exatamente 8 d√≠gitos
    valor = valor.substring(0, 8);

    // Aplica a m√°scara quando houver ao menos 1 d√≠gito
    if (valor.length >= 1) {
      valor = valor.replace(/^(\d{0,2})(\d{0,6})$/, function (_, int, dec) {
        if (dec) return `-${int},${dec}`;
        return `-${int}`;
      });
    }

    return valor; 

  }

  /// *** FORMATA A DATA *** ///
  function formatarDataParaInput(dataTexto) {
    if (!dataTexto) return '';

    // Esperado: DD/MM/YYYY

    if (dataTexto.includes('-')) {
      return dataTexto.substring(0, 10);
    }

    const [dia, mes, ano] = dataTexto.split('/');
    return `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
  }

  /// *** FORMATA A HORA *** ///
  function formatarHoraParaInput(hora) {
    if (!hora) return '';

    // üîπ Se j√° for Date
    if (hora instanceof Date) {
      const h = String(hora.getHours()).padStart(2, '0');
      const m = String(hora.getMinutes()).padStart(2, '0');
      return `${h}:${m}`;
    }

    // üîπ Se vier como n√∫mero (ex: 930 ou 1430)
    if (typeof hora === 'number') {
      const str = hora.toString().padStart(4, '0');
      return `${str.substring(0, 2)}:${str.substring(2, 4)}`;
    }

    // üîπ Converte tudo para string
    hora = hora.toString().trim();

    // üîπ ISO datetime (ex: 2026-01-05T14:30:00.000Z)
    if (hora.includes('T')) {
      const data = new Date(hora);
      if (!isNaN(data)) {
        const h = String(data.getHours()).padStart(2, '0');
        const m = String(data.getMinutes()).padStart(2, '0');
        return `${h}:${m}`;
      }
    }

    // üîπ Remove tudo que n√£o for n√∫mero
    const numeros = hora.replace(/\D/g, '');

    if (numeros.length >= 3) {
      const h = numeros.slice(0, numeros.length - 2).padStart(2, '0');
      const m = numeros.slice(-2);
      return `${h}:${m}`;
    }

    if (numeros.length === 2) {
      return `${numeros}:00`;
    }

    return '';
  }


  //////////////////////////////////// ***** SALVAMENTO DE DADOS NA PLANILHA GOOGLE ***** ////////////////////////////////////

  /// *** ADICIONA CADA IMAGEM Base64 *** ///
  const LIMITE_POR_IMAGEM_MB = 2;   // 2 MB por imagem
  const LIMITE_TOTAL_MB = 10;      // 10 MB no total
  async function filesToBase64(files) {
    let totalSize = 0;
    const resultados = [];

    for (const file of files) {
      const sizeMB = file.size / (1024 * 1024);
      if (sizeMB > LIMITE_POR_IMAGEM_MB) {
        throw new Error(`A imagem "${file.name}" excede ${LIMITE_POR_IMAGEM_MB} MB`);
      }
      totalSize += sizeMB;
    }

    if (totalSize > LIMITE_TOTAL_MB) {
      throw new Error(`Tamanho total das imagens excede ${LIMITE_TOTAL_MB} MB`);
    }

    let concluido = 0;

    for (const file of files) {
      const base64 = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });

      resultados.push({
        name: file.name,
        type: file.type,
        data: base64
      });

    }

    return resultados;
  }

  /// *** SALVA OS DADOS NA PLANILHA DO GOOGLE *** ///
¬† const saveBtn = document.getElementById('saveToSheetButton');
  saveBtn.addEventListener('click', async () => {

    // üî∏ Valida√ß√£o autom√°tica dos campos required
    if (!form.checkValidity()) {
      form.reportValidity(); // mostra os erros na tela
      return; // interrompe o envio
    }

    
    mostrarStatus("Enviando Dados da Ocorr√™ncia...", 0);
    saveBtn.disabled = true;

    let retorno = null

    try {

      const formData = new FormData(form);


      const fotosInput = document.getElementById('fotosInput');

      let fotosBase64 = [];

      if (fotosInput.files.length > 0) {
        fotosBase64 = await filesToBase64(fotosInput.files);
      }

      formData.append('fotosBase64', JSON.stringify(fotosBase64));


      // for√ßa nome em mai√∫sculas
      const nomeComunicante = formData.get('nomeComunicante');
      if (nomeComunicante) {
        formData.set('nomeComunicante', nomeComunicante.toUpperCase());
      }

      // ‚≠ê ALTERADO ‚Äî capturar selecionados do Choices
      const recursosSelecionados = recursosChoices ? recursosChoices.getValue(true) : [];
      const participacaoSelecionados = participacaoChoices ? participacaoChoices.getValue(true) : [];
      const fontesInformacaoSelecionados = fontesInformacaoChoices ? fontesInformacaoChoices.getValue(true) : [];

      // salvar como string separada por v√≠rgula
      formData.set('recursosEmpenhados', recursosSelecionados.join(", "));
      formData.set('participacaoInstitucional', participacaoSelecionados.join(", "));
      formData.set('fontesInformacao', fontesInformacaoSelecionados.join(", "));

      // üî∏ Envio de Dados para o Apps Script que precisa identificar a a√ß√£o:
      formData.append('action', 'saveOne');

      const response = await fetch(appScriptUrl, {
        method: "POST",
        body: formData
      });

      const result = await response.json();

      if (result.status === 'SUCCESS') {
        mostrarStatus("‚úÖ Registro salvo!", 1500);
      } else {
        mostrarStatus("‚ö†Ô∏è" + result.message, 3000);
      }

      retorno = result.status;

    } catch (err) {
      mostrarStatus("‚ùå Falha: " + err.message);
    }


    finally {

      saveBtn.disabled = false;

    }

    if (retorno === 'SUCCESS') {

      form.reset();

      // ‚≠ê ADICIONADO ‚Äî limpar visual do Choices tamb√©m
      if (recursosChoices) recursosChoices.removeActiveItems();
      if (participacaoChoices) participacaoChoices.removeActiveItems();
      if (fontesInformacaoChoices) fontesInformacaoChoices.removeActiveItems();
      document.getElementById('listaFotos').innerHTML = "";
      document.getElementById('fotosInput').value = ""; // Tamb√©m limpa o input de arquivo

      //Volta os selects normais para a op√ß√£o "Selecione..."
      const selects = form.querySelectorAll('select');
      selects.forEach(select => {
          if (!select.hasAttribute('multiple')) {
             select.value = "";
          }
      });

      document.getElementById('responsavelSelect').value = 'plantonista';
      document.getElementById("responsavelSelect").dispatchEvent(new Event("change"));
    
    }

    voltarAoTopo()

  });


  //////////////////////////////////// ***** ALTERN√ÇNCIA ENTRE CAMPOS DO FORMUL√ÅRIO ***** ////////////////////////////////////

  /// *** ALTERNA ENTRE OS CAMPOS PLANTONISTA E COMUNICANTE *** ///
  document.getElementById("responsavelSelect").addEventListener("change", function () {
    const plantonista = document.getElementById("fieldsetPlantonista");
    const comunicante = document.getElementById("fieldsetComunicante");

    // Esconde e limpa ambos primeiro
    plantonista.style.display = "none";
    comunicante.style.display = "none";
    resetarFieldset("fieldsetPlantonista");
    resetarFieldset("fieldsetComunicante");
    nmFunc.style.borderColor = "";
    nmFunc.style.color = "";
    acesso.style.borderColor = "";
    acesso.style.color = "";

    // campos do comunicante
    const camposComunicante = comunicante.querySelectorAll('[required]');
    const camposPlantonista = plantonista.querySelectorAll('[required]');

    if (this.value === "plantonista") {
      plantonista.style.display = "block";
      camposComunicante.forEach(c => c.removeAttribute('required'));
      camposPlantonista.forEach(c => c.setAttribute('required', ''));
    }

    if (this.value === "comunicante") {
      comunicante.style.display = "block";
      camposPlantonista.forEach(c => c.removeAttribute('required'));
      camposComunicante.forEach(c => c.setAttribute('required', ''));
    }

  });

  /// *** COMPLEMENTA A FUN√á√ÉO QUE ALTERNA OS PLANTONISTA E COMUNICANTE *** ///
  function resetarFieldset(fieldsetId) {
    const fieldset = document.getElementById(fieldsetId);
    if (!fieldset) return;

    const campos = fieldset.querySelectorAll(
      'input, select, textarea'
    );

    campos.forEach(campo => {
      if (campo.tagName === 'SELECT') {
        campo.selectedIndex = 0; // primeira op√ß√£o
      } 
      else if (campo.type === 'checkbox' || campo.type === 'radio') {
        campo.checked = false;
      } 
      else {
        campo.value = '';
      }
    });
  }


  //////////////////////////////////// ***** VALIDA√á√ÉO DE N√öMERO FUNCIONAL E SENHA ***** ////////////////////////////////////

  /// *** VALIDA√á√ÉO DO NUMERO FUNCIONAL DO PLANTONISTA *** ///
  const nmFunc = document.getElementById('numeroFuncional');
  async function validarPlantonistaFrontend() {
    const plantonista = document.getElementById("plantonistaSelect").value;
    const numeroFuncional = document.getElementById("numeroFuncional").value;

    if (!plantonista || !numeroFuncional) {
      //alert("Informe o plantonista e o n√∫mero funcional.");
      statusArea.textContent = "‚ö†Ô∏è Informe o plantonista e o n√∫mero funcional.";
      statusArea.style.display = "block";
      setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
      return false;
    }

    const params = new URLSearchParams({
      action: "validarPlantonista",
      plantonista,
      numeroFuncional
    });

    try {
      const response = await fetch(`${appScriptUrl}?${params.toString()}`);
      const result = await response.json();

      if (result.status !== "SUCCESS") {
        //alert(result.message || "‚ö†Ô∏è Erro ao validar plantonista.");
        nmFunc.style.borderColor = "#E74C3C";
        nmFunc.style.color = "#E74C3C";
        statusArea.textContent = "‚ö†Ô∏è Erro ao validar plantonista.";
        statusArea.style.display = "block";
        setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
        return false;
      }

      if (!result.data.autorizado) {
        //alert("‚ö†Ô∏è Plantonista ou n√∫mero funcional n√£o autorizado.");
        nmFunc.style.borderColor = "#E74C3C";
        nmFunc.style.color = "#E74C3C";
        statusArea.textContent = "‚ö†Ô∏è Plantonista ou n√∫mero funcional n√£o autorizado.";
        statusArea.style.display = "block";
        setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
        return false;
      }

      nmFunc.style.borderColor = "";
      nmFunc.style.color = "";
      return true;

    } catch (error) {
      console.error("Erro na valida√ß√£o:", error);
      //alert("‚ö†Ô∏è Falha de comunica√ß√£o com o servidor.");
      nmFunc.style.borderColor = "#E74C3C";
      nmFunc.style.color = "#E74C3C";
      statusArea.textContent = "‚ö†Ô∏è Falha de comunica√ß√£o com o servidor.";
      statusArea.style.display = "block";
      setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
      return false;
    }
  }
  numeroFuncional.addEventListener('change', validarPlantonistaFrontend);
  plantonistaSelect.addEventListener('change', validarPlantonistaFrontend);

  /// *** VALIDA√á√ÉO DE SENHA DO COMUNICANTE *** ///
  const acesso = document.getElementById('senha');
  async function validarSenhaFrontend() {
    const senha = document.getElementById("senha").value;

    if (!senha) {
      statusArea.textContent = "Informe a sua senha.";
      statusArea.style.display = "block";
      setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
      return false;
    }

    const params = new URLSearchParams({
      action: "validarSenha",
      senha
    });

    try {
      const response = await fetch(`${appScriptUrl}?${params.toString()}`);
      const result = await response.json();

      if (result.status !== "SUCCESS") {
        acesso.style.borderColor = "#E74C3C";
        acesso.style.color = "#E74C3C";
        statusArea.textContent = "‚ö†Ô∏è Erro ao validar senha.";
        statusArea.style.display = "block";
        setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
        return false;
      }

      if (!result.data.autorizado) {
        acesso.style.borderColor = "#E74C3C";
        acesso.style.color = "#E74C3C";
        statusArea.textContent = "‚ö†Ô∏è Senha n√£o autorizada.";
        statusArea.style.display = "block";
        setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
        return false;
      }

      acesso.style.borderColor = "";
      acesso.style.color = "";
      return true;

    } catch (error) {
      console.error("Erro na valida√ß√£o:", error);
      acesso.style.borderColor = "#E74C3C";
      acesso.style.color = "#E74C3C";
      statusArea.textContent = "‚ö†Ô∏è Falha de comunica√ß√£o com o servidor.";
      statusArea.style.display = "block";
      setTimeout(() => { statusArea.style.display = "none"; statusArea.textContent = ""; }, 3000);
      return false;
    }
  }
  senha.addEventListener('change', validarSenhaFrontend);


  //////////////////////////////////// ***** PROMOVE O CARREGAMENTO DOS DADOS INICIAIS PARA PREENCHIMENTO DO FORMUL√ÅRIO ***** ////////////////////////////////////

¬† // Executa o carregamento dos dados quando o documento estiver pronto
¬† document.addEventListener("DOMContentLoaded", init);

  function init() {
    fetchLookupData();          // j√° existente
    configurarFiltroOcorrencias(); // üîµ NOVO
  }

</script>

</body>

</html>
